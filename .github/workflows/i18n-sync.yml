name: I18n Documentation Sync

on:
  push:
    paths:
      - 'README.md'
      - 'README-EN.md'
      - '.github/README.md'
  pull_request:
    paths:
      - 'README.md'
      - 'README-EN.md'
      - '.github/README.md'

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm install -g markdown-link-check@latest
        npm install -g markdownlint-cli
        
    - name: Check markdown links
      run: |
        npx markdown-link-check README.md
        npx markdown-link-check README-EN.md
        npx markdown-link-check .github/README.md
        
    - name: Lint markdown files
      run: |
        markdownlint README.md
        markdownlint README-EN.md
        markdownlint .github/README.md
        
    - name: Check language consistency
      run: |
        # Check if language switcher links are present
        if ! grep -q "语言.*English.*中文" README.md; then
          echo "Missing language switcher in Chinese README"
          exit 1
        fi
        
        if ! grep -q "Language.*English.*中文" README-EN.md; then
          echo "Missing language switcher in English README"
          exit 1
        fi
        
    - name: Validate contact information
      run: |
        # Check if contact information is present
        if ! grep -Eq '([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})|(联系|Contact).*(表单|Issue|飞书|微信|QQ|Discord|Telegram|Link|链接)' README.md; then
          echo "Missing contact info in Chinese README"
          exit 1
        fi
        
        if ! grep -Eq '([A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,})|(联系|Contact).*(表单|Issue|飞书|微信|QQ|Discord|Telegram|Link|链接)' README-EN.md; then
          echo "Missing contact info in English README"
          exit 1
        fi
        
    - name: Check Docker support
      run: |
        # Check if Docker support is mentioned
        if ! grep -q "Docker" README.md; then
          echo "Missing Docker support in Chinese README"
          exit 1
        fi
        
        if ! grep -q "Docker" README-EN.md; then
          echo "Missing Docker support in English README"
          exit 1
        fi
        
    - name: Generate documentation report
      run: |
        echo "# Documentation Sync Report" > docs/sync-report.md
        echo "" >> docs/sync-report.md
        echo "## Files Checked" >> docs/sync-report.md
        echo "- README.md (Chinese)" >> docs/sync-report.md
        echo "- README-EN.md (English)" >> docs/sync-report.md
        echo "- .github/README.md (GitHub Homepage)" >> docs/sync-report.md
        echo "" >> docs/sync-report.md
        echo "## Status" >> docs/sync-report.md
        echo "✅ All documentation files are synchronized" >> docs/sync-report.md
        echo "✅ Language switchers are present" >> docs/sync-report.md
        echo "✅ Contact information is consistent" >> docs/sync-report.md
        echo "✅ Docker support is documented" >> docs/sync-report.md
        echo "" >> docs/sync-report.md
        echo "Last updated: $(date)" >> docs/sync-report.md
        
    - name: Upload documentation report
      uses: actions/upload-artifact@v4
      with:
        name: documentation-report
        path: docs/sync-report.md
